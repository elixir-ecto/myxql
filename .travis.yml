language: elixir
services:
  - docker
elixir: 1.7
otp_release: 21.1
addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-client
env:
  global:
    - MYSQL_UNIX_PORT=/var/run/mysqld/mysqld.sock
  matrix:
    - DB=mysql:5.7
    - DB=mysql:8.0
    - CHECKS=true
matrix:
  include:
    - elixir: 1.4
      otp_release: 18.3
    - elixir: 1.5
      otp_release: 19.3
before_install:
  - docker pull $DB || true
  - sudo chmod 777 -R /var/run/mysqld
  - docker run --name mysql -p 3306:3306 --volume /var/run/mysqld:/var/run/mysqld -e MYSQL_ALLOW_EMPTY_PASSWORD=1 -d $DB
  - mysql --version
  - until mysql -u root -e "SELECT @@version;"; do sleep 1; done
script:
  - [ -n "$CHECKS" ] && mix format --check-formatted
  - mix test
